<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Bookshelf</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
<div class="app"><div class="appInner">
  <header class="topbar">
      <button id="btnSidebarToggle" class="iconBtn" title="設定の表示/非表示">≡</button>

    <div class="brand">
      <div class="logo">📚</div>
      <div class="brandText">
        <div class="brandTitle">My Bookshelf</div>
        <div class="brandSub">本棚 / 欠巻手動追加 / 表紙⇔背表紙切替 / 画像は images/ フォルダ運用（巻はフォルダから生成）</div>
      </div>
    </div>

      <div class="searchArea">
    <input id="q" class="input" placeholder="本棚内を検索（例：NARUTO）" />
    <button id="btnAddSeriesManual" class="btn primary">＋シリーズ追加</button>
    <button id="btnGenerateAllFromFolders" class="btn">フォルダ→巻生成</button>
  </div>
</header>

    <div id="quickControls" class="quickControls">
      <div class="qcLeft">
        <button id="btnQuickAll" class="btn">＜ ALL ＞</button>
        <button id="btnPrevSeries" class="btn ghost">＜</button>
        <div id="qcSeriesName" class="qcSeriesName">-</div>
        <button id="btnNextSeries" class="btn ghost">＞</button>
      </div>

      
      <div class="qcCenter">
        <div class="qcGrid">
          <div class="qcLine1">
            <div class="seg">
              <button id="btnQuickSpine" class="btn">背表紙</button>
              <button id="btnQuickCover" class="btn">表紙</button>
            </div>

            <label class="qcCap">
              <span>背</span>
              <input id="rowCapSpineTop" class="input tiny" type="number" min="0" max="300" step="1" value="20" />
            </label>
            <label class="qcCap">
              <span>表</span>
              <input id="rowCapCoverTop" class="input tiny" type="number" min="0" max="300" step="1" value="10" />
            </label>

            <button id="btnApplyLayoutTop" class="btn primary">反映</button>

            <label class="qcCap">
              <span>背W</span>
              <input id="spineWTop" class="input tiny" type="number" min="40" max="200" step="1" value="90" />
            </label>
            <label class="qcCap">
              <span>背H</span>
              <input id="spineHTop" class="input tiny" type="number" min="200" max="1200" step="1" value="900" />
            </label>
            <button id="btnApplySizeTop" class="btn">サイズ反映</button>

            <button id="btnImagePathUpdate" class="btn" title="表紙/背表紙の画像を一括で再読込（結果を表示・ログ出力）">画像パス更新</button>
            <button id="btnCacheRefresh" class="btn ghost" title="このページの画像キャッシュを更新（URLを変えて再取得させます）">キャッシュ更新</button>
            <div id="qcStatus" class="smallText">perRow: -</div>
          </div>

          <div class="qcLine2">
            <div class="qcSpacer"></div>
            <label class="qcCap">
              <span>表W</span>
              <input id="coverWTop" class="input tiny" type="number" min="80" max="400" step="1" value="160" />
            </label>
            <label class="qcCap">
              <span>表H</span>
              <input id="coverHTop" class="input tiny" type="number" min="120" max="800" step="1" value="240" />
            </label>
          </div>
        </div>
      </div>

      <div class="qcRight">

        <button id="btnQuickToggleSidebar" class="btn ghost">設定</button>
      </div>
    </div>


  <main class="layout">
    <aside id="sidebar" class="sidebar">
      <div class="panel">
        <div class="panelTitle">表示</div>
        <div class="modeRow">
          <button id="btnModeAll" class="btn">全て表示</button>
          <button id="btnModeSeries" class="btn">シリーズ別</button>
        </div>
        <div class="modeRow" style="margin-top:8px;">
          <button id="btnViewSpine" class="btn">背表紙ビュー</button>
          <button id="btnViewCover" class="btn">表紙ビュー</button>
        </div>
        <div class="smallText" id="modeHint">現在：シリーズ別 / 背表紙</div>

        <div class="bulkGrid" style="margin-top:10px;">
          <button id="btnOpenSeriesModal" class="btn">シリーズ編集</button>
          <button id="btnRecolorSeriesRandom" class="btn">色ランダム</button>
        </div>

        <div class="hr"></div>

        <div class="panelTitle">シリーズ</div>
        <div id="seriesList" class="seriesList"></div>

        <div class="hr"></div>

        <div class="panelTitle">シリーズ一括操作（シリーズ別の時）</div>
        <div class="bulkGrid">
          <button id="btnAllOwned" class="btn">全巻 所持</button>
          <button id="btnAllUnowned" class="btn">全巻 未所持</button>
        </div>

        <div class="rangeBox">
          <div class="rangeRow">
            <input id="rangeFrom" class="input tiny" placeholder="from" inputmode="numeric" />
            <span>〜</span>
            <input id="rangeTo" class="input tiny" placeholder="to" inputmode="numeric" />
          </div>
          <div class="bulkGrid">
            <button id="btnRangeOwned" class="btn">範囲 所持</button>
            <button id="btnRangeUnowned" class="btn">範囲 未所持</button>
          </div>
        </div>

        <div class="hr"></div>
        <div class="smallText">
          未所持はグレー表示。<br />
          長押しで選択モード。PCはShiftで範囲選択。
        </div>

        <div class="hr"></div>
        <div class="smallText footnote">画像は <code>images/</code> に置いて、パスで指定します（例：<code>images/onepiece01.png</code>）</div>
      </div>
    
        <div class="divider"></div>
        <div class="panelTitle">段組み / 表示</div>

        <label class="f">
          <span>1段あたりの冊数（背表紙 / 0=自動）</span>
          <input id="rowCapSpine" class="input" type="number" min="0" max="300" step="1" value="0" />
          <div class="smallText">例：20（背表紙は20冊ごとに下の段へ）</div>
        </label>

        <label class="f">
          <span>1段あたりの冊数（表紙 / 0=自動）</span>
          <input id="rowCapCover" class="input" type="number" min="0" max="300" step="1" value="10" />
          <div class="smallText">例：10（表紙は10冊ごとに下の段へ）</div>
        </label>

        <div class="row" style="gap:8px; margin-top:8px;">
          <button id="btnApplyLayout" class="btn">段組みを反映</button>
          <div class="smallText" style="align-self:center;">※押すと段数・表示を再計算します</div>
        </div>

        <div class="smallText" id="rowCapStatus">perRow: -</div>



        <label class="checkRow">
          <input id="autoFit" type="checkbox" checked />
          <span>100%表示でも収まるよう自動縮小</span>
        </label>
<div class="divider"></div>
        <div class="panelTitle">データ入出力</div>
        <div class="row" style="gap:8px; flex-wrap:wrap;">
          <button id="btnExport" class="btn">エクスポート(JSON)</button>
          <label class="btn" style="cursor:pointer;">インポート(JSON)
            <input id="fileImport" type="file" accept="application/json" style="display:none;" />
          </label>
        </div>
        <div class="smallText">ローカル保存データをJSONでバックアップ/復元します。</div>
</aside>

    <section class="content">
<div class="panel shelfPanel">
        <div class="panelTitleRow">
          <div>
            <div class="panelTitle" id="shelfTitle">本棚</div>
            <div class="smallText" id="shelfMeta">シリーズを追加してください。</div>
          </div>

          <div class="rightActions">
            <button id="btnApplyImagesSeries" class="btn ghost">画像パス適用</button>
        <button id="btnAddSpine" class="btn">欠巻を追加</button>
            <button id="btnToggleSelectMode" class="btn">選択モード</button>
            <button id="btnSeriesDelete" class="btn danger">シリーズ削除</button>
          </div>
        </div>

        <div id="shelf" class="shelf" aria-label="bookshelf"></div>
      </div>
    </section>
  </main>

  <!-- Selection bar -->
  <div id="selectBar" class="selectBar hidden">
    <div class="selectInfo">
      <span id="selectedCount">選択数: 0</span>
      <span class="sep">|</span>
      <span class="hint">長押しで開始 / Shiftで範囲選択</span>
    </div>
    <div class="selectActions">
      <button id="btnSelOwned" class="btn">選択→所持</button>
      <button id="btnSelUnowned" class="btn">選択→未所持</button>
      <button id="btnSelDelete" class="btn danger">選択→削除</button>
      <button id="btnSelClear" class="btn">選択解除</button>
      <button id="btnSelExit" class="btn primary">完了</button>
    </div>
  </div>

  <!-- Volume Modal -->
  <div id="modal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modalInner">
      <div class="openBookWrap">
        <div class="openBook openBookBg">
          <div class="pages bookPages">
            <!-- 右上の閉じる（常に表示） -->
            <button id="btnCloseModal" class="btn ghost bookCloseBtn" type="button">閉じる</button>

            <div class="bookSpread">
              <!-- Left: big cover + fixed spine -->
              <section class="bookPage left">
                <div class="fixedSpine">
                  <div id="spineTitleFixed" class="fixedSpineTitle">-</div>
                </div>

                <div class="bigCoverArea">
                  <div class="coverTopLabel">タイトル</div>
                  <img id="detailCoverLarge" alt="" />
                </div>

                <div class="leftBottomActions">
                  <button id="btnDeleteVolume" class="btn danger" type="button">この巻を削除</button>
                </div>
              </section>

              <!-- Right: page1=view / page2=edit -->
              <section class="bookPage right">
                <div class="bookRightHead">
                  <div class="bookTitleArea">
                    <div class="modalTitle" id="mTitle">Title</div>
                    <div class="modalMeta" id="mMeta">Meta</div>
                  </div>

                  <!-- tabs are kept for keyboard/desktop; ボタンでも移動できる -->
                  <div class="bookTabs">
                    <button id="tabView" class="tabBtn isActive" type="button">表示</button>
                    <button id="tabEdit" class="tabBtn" type="button">編集</button>
                  </div>
                </div>

                <div class="bookRightBody">
                  <!-- Page 1: View (no scroll; clamp long text) -->
                  <div id="paneView" class="tabPane">
                    <div class="viewGrid">
                      <div class="viewRow"><div class="k">シリーズ</div><div class="v" id="vSeries">-</div></div>
                      <div class="viewRow"><div class="k">巻</div><div class="v" id="vVolNo">-</div></div>
                      <div class="viewRow"><div class="k">出版社</div><div class="v" id="vPublisher">-</div></div>
                      <div class="viewRow"><div class="k">ISBN13</div><div class="v" id="vIsbn">-</div></div>
                      <div class="viewRow"><div class="k">リンク</div><div class="v"><a id="vLink" href="#" target="_blank" rel="noreferrer">-</a></div></div>

                      <div class="viewHr"></div>

                      <div class="viewRow"><div class="k">表示タイトル</div><div class="v" id="vDisplayTitle">-</div></div>
                      <div class="viewRow"><div class="k">購入サイト</div><div class="v" id="vSite">-</div></div>
                      <div class="viewRow"><div class="k">URL/パス</div><div class="v" id="vUrl">-</div></div>

                      <div class="viewHr"></div>

                      <div class="viewRow"><div class="k">背表紙テキスト</div><div class="v" id="vSpineText">-</div></div>
                      <div class="viewRow"><div class="k">背表紙色</div><div class="v" id="vSpineColor">-</div></div>
                      <div class="viewRow"><div class="k">格納パス</div><div class="v" id="vStoragePath">-</div></div>

                      <div class="viewHr"></div>

                      <div class="modalActions bookActionBar">
                        <button id="btnToggleOwned" class="btn primary" type="button">所持にする</button>
                        <button id="btnOpenLink" class="btn" type="button" disabled>この巻を開く</button>
                        <button id="btnToEdit" class="btn" type="button">次へ</button>
                      </div>
                    </div>
                  </div>

                  <!-- Page 2: Edit (no scroll; compact form) -->
                  <div id="paneEdit" class="tabPane" hidden>
                    <div class="editGridCompact">
                      <label class="f"><span>表示タイトル</span><input id="mDisplayTitle" class="input" /></label>
                      <label class="f"><span>購入サイト</span><input id="mSite" class="input" /></label>
                      <label class="f colSpan2"><span>URL/パス</span><input id="mUrl" class="input" placeholder="https:// / アプリのURL / メモ用パス" /></label>

                      <label class="f"><span>背表紙テキスト</span><input id="mSpineText" class="input" /></label>
                      <label class="f"><span>背表紙色</span><input id="mSpineColor" class="input" placeholder="#ffcc00 など" /></label>

                      <label class="f colSpan2"><span>この巻を開く：格納パス</span><input id="mStoragePath" class="input" placeholder="例：D:\books\NARUTO\01.epub  /  例：/mnt/books/NARUTO/01.pdf" /></label>

                      <div class="smallText colSpan2">※スクロールしない表示のため、編集項目は“表示に必要なもの”に絞っています。</div>

                      <div class="modalActions bookActionBar colSpan2">
                        <button id="btnSaveMeta" class="btn primary" type="button">保存</button>
                        <button id="btnToView" class="btn" type="button">前へ</button>
                        <button id="btnToggleOwned2" class="btn" type="button">未所持 or 所持</button>
                        <button id="btnCloseModal2" class="btn ghost" type="button">閉じる</button>
                      </div>
                    </div>

                    <!-- hidden legacy inputs to keep JS safe (unused, but referenced) -->
                    <input id="mCoverPath" class="input" style="display:none" />
                    <input id="mSpinePath" class="input" style="display:none" />
                    <img id="mCoverPrev" class="thumb" alt="" style="display:none" />
                    <img id="mSpinePrev" class="thumb" alt="" style="display:none" />
                    <input id="mCoverPick" type="file" accept="image/*" style="display:none" />
                    <input id="mSpinePick" type="file" accept="image/*" style="display:none" />
                    <button id="btnUseCoverFilename" style="display:none"></button>
                    <button id="btnUseSpineFilename" style="display:none"></button>
                    <button id="btnTrimCover" style="display:none"></button>
                    <button id="btnTrimSpine" style="display:none"></button>
                    <button id="btnDlTrimCover" style="display:none"></button>
                    <button id="btnDlTrimSpine" style="display:none"></button>
                  </div>
                </div>
              </section>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script src="./compat.js"></script>
<script src="./app.js"></script>
</div></div>

  <!-- Import Mode Modal -->
  <div id="importModal" class="modal hidden" aria-hidden="true">
    <div class="modalBackdrop"></div>
    <div class="modalCard">
      <div class="modalTitle">インポート方法を選択</div>
      <div class="modalBody">
        <label class="radioRow">
          <input type="radio" name="importMode" value="overwrite" checked />
          <div>
            <div class="radioTitle">上書き（置き換え）</div>
            <div class="smallText">現在の本棚データをインポートしたJSONで丸ごと置き換えます。</div>
          </div>
        </label>
        <label class="radioRow">
          <input type="radio" name="importMode" value="merge" />
          <div>
            <div class="radioTitle">マージ（追加）</div>
            <div class="smallText">現在のデータを残しつつ、JSON側のシリーズ/巻を不足分だけ追加します（同じIDは基本的に現状優先）。</div>
          </div>
        </label>
      </div>
      <div class="modalActions">
        <button id="btnImportCancel" class="btn ghost">キャンセル</button>
        <button id="btnImportProceed" class="btn">この方法でインポート</button>
      </div>
    </div>
  </div>

  <!-- Apply Images Modal -->
  <div id="applyImagesModal" class="modalBackdrop" style="display:none;">
    <div class="modalCard">
      <div class="modalHead">
        <div class="modalTitle">画像パス適用</div>
        <button id="btnApplyImagesClose" class="iconBtn" title="閉じる">×</button>
      </div>

      <div class="modalBody">
        <div class="modalGroup">
          <div class="modalLabel">対象範囲</div>
          <div class="seg">
            <button id="applyScopeAll" class="btn">ALL</button>
            <button id="applyScopeSeries" class="btn">シリーズ</button>
          </div>
          <div class="smallText">シリーズは「いま表示しているシリーズ」だけに適用します。</div>
        </div>

        <div class="modalGroup">
          <div class="modalLabel">適用対象</div>
          <div class="seg">
            <button id="applyKindBoth" class="btn primary">すべて</button>
            <button id="applyKindCover" class="btn">表紙</button>
            <button id="applyKindSpine" class="btn">背表紙</button>
          </div>
        </div>

        <div class="modalActions">
          <button id="btnGenerateFromFolder" class="btn">フォルダから巻生成＋設定</button>
          <button id="btnApplyImagesRun" class="btn primary">実行</button>
          <button id="btnApplyImagesCancel" class="btn">キャンセル</button>
        </div>

        <div id="applyImagesResult" class="smallText" style="margin-top:8px;"></div>
      </div>
    </div>
  </div>


<div id="buildBadge" style="position:fixed;left:8px;bottom:8px;z-index:9999;background:rgba(0,0,0,.65);color:#fff;padding:6px 8px;border-radius:10px;font:12px/1.2 system-ui;max-width:75vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">build: <span id="buildBadgeText">(loading)</span></div>
<script>(function(){function u(){var t=window.__MY_BOOKSHELF_BUILD__||'unknown';var e=document.getElementById('buildBadgeText');if(e)e.textContent=t;}u();window.addEventListener('load',u);})();</script>
</body>
</html>